name: Cover me
on:
  push:
    branches:
    - main
    - develop

  pull_request:
    branches:
    - main
    - develop


jobs:
  coverage:
    needs: [lint,build-dev-container]

    runs-on: devcontainer:main
    container:
      image: ghcr.io/bython-talk/devcontainer:main
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.DOCKER_CONTAINER_REGISTRY_TOKEN }}

    # To enable coverage, delete the last line from the conditional below and
    # edit the "<name>" placeholder to your GitHub name.
    # If you do not wish to use codecov, then simply delete this job from the
    # workflow.
    if: github.repository_owner == 'bython-talk'

    steps:
    - uses: actions/checkout@v3
    - name: Install LCov and make
      run: |
        apt-get -qq install cmake lcov make -y

    - name: Configure
      run: cmake -Wno-error=dev --preset=ci-coverage

    - name: Build
      run: cmake --build build/coverage -j 2

    - name: Test
      working-directory: build/coverage
      run: ctest --output-on-failure --no-tests=error -j 2

    - name: Process coverage info
      run: cmake --build build/coverage -t coverage

    - name: Submit to codecov.io
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: build/coverage/coverage.info
        fail_ci_if_error: true