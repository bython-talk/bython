FROM ghcr.io/bython-talk/alpine-catch:latest AS catch2-dev
WORKDIR /

FROM catch2-dev AS lexy-catch2-dev

WORKDIR /
RUN wget https://github.com/foonathan/lexy/archive/refs/tags/v2022.12.1.zip -O /lexy.zip && unzip /lexy.zip -d /lexy

WORKDIR /lexy/lexy-2022.12.1/
RUN cmake -E make_directory build

WORKDIR /lexy/lexy-2022.12.1/build
RUN cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_LIBDIR=/usr/lib/ \
    -DLEXY_BUILD_BENCHMARKS=OFF \
    -DLEXY_BUILD_EXAMPLES=OFF \
    -DLEXY_BUILD_TESTS=OFF \
    -DLEXY_BUILD_DOCS=OFF \
		-DLEXY_BUILD_PACKAGE=OFF \
		-DLEXY_ENABLE_INSTALL=ON \
    /lexy/lexy-2022.12.1

RUN cmake --build . -j4
RUN cmake --install .

FROM lexy-catch2-dev AS bython-dev

WORKDIR /
RUN apk add --no-cache gdb cppcheck samurai libxml2-dev gzip

ENTRYPOINT [ "/bin/sh" ]
